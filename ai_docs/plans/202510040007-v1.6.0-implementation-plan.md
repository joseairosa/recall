# v1.6.0 Implementation Plan: Infrastructure & Quality

**Status:** Planning
**Created:** 2025-10-04
**Target Release:** v1.6.0
**Estimated Time:** 6-8 hours

---

## Overview

Improve project **infrastructure, quality, and developer experience** after implementing major features in v1.3-v1.5. Focus on CI/CD, containerization, testing improvements, and bug fixes.

### Goals

1. Automate testing and release workflow with GitHub Actions
2. Provide Docker image for easy deployment
3. Expand testing framework beyond basic checks
4. Fix known ANTHROPIC_API_KEY bug
5. Improve error messages and logging
6. Make project more professional and maintainable

### Why This Matters

We've built significant functionality (global memories, relationships, versioning, templates, categories) but infrastructure is lacking:
- âŒ No CI/CD - manual testing is tedious and error-prone
- âŒ No Docker image - harder for users to deploy/try
- âš ï¸ Basic testing - shell scripts but no proper test framework
- ðŸ› Known bug requiring ANTHROPIC_API_KEY even for basic ops
- âš ï¸ Poor error messages - hard to debug issues

This release makes Recall production-ready and easier to contribute to.

---

## Technical Design

### 1. CI/CD Pipeline (GitHub Actions)

#### Workflow: Test & Lint

**File:** `.github/workflows/test.yml`

```yaml
name: Test & Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          test -f dist/index.js
          head -1 dist/index.js | grep -q "^#!/usr/bin/env node"

      - name: Run static tests
        run: ./tests/test-v1.5.0-simple.sh

      - name: Run runtime tests
        env:
          REDIS_URL: redis://localhost:6379
          ANTHROPIC_API_KEY: test-key
          OPENAI_API_KEY: test-key
        run: node tests/test-runtime.js

      - name: Check bundle size
        run: |
          SIZE=$(stat -f%z dist/index.js 2>/dev/null || stat -c%s dist/index.js)
          MAX_SIZE=250000
          if [ $SIZE -gt $MAX_SIZE ]; then
            echo "Bundle size $SIZE exceeds limit $MAX_SIZE"
            exit 1
          fi
```

#### Workflow: Security Scan

**File:** `.github/workflows/security.yml`

```yaml
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true
```

#### Workflow: Publish to npm

**File:** `.github/workflows/publish.yml`

```yaml
name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run all tests
        env:
          REDIS_URL: redis://localhost:6379
          ANTHROPIC_API_KEY: test-key
          OPENAI_API_KEY: test-key
        run: |
          ./tests/test-v1.5.0-simple.sh
          node tests/test-runtime.js

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public

      - name: Verify published version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          npx -y @joseairosa/recall@$VERSION --version
```

---

### 2. Docker Image

#### Dockerfile

**File:** `Dockerfile`

```dockerfile
# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source
COPY . .

# Build TypeScript
RUN npm run build

# Runtime stage
FROM node:20-alpine

WORKDIR /app

# Install dumb-init for proper signal handling
RUN apk add --no-cache dumb-init

# Copy built app and dependencies
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./

# Create non-root user
RUN addgroup -g 1001 -S recall && \
    adduser -u 1001 -S recall -G recall

USER recall

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"

# Expose port (if we add HTTP endpoint in future)
EXPOSE 3000

# Use dumb-init to handle signals properly
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Run the MCP server
CMD ["node", "dist/index.js"]
```

#### Docker Compose

**File:** `docker-compose.yml`

```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  recall:
    build: .
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-not-required}
      - WORKSPACE_MODE=${WORKSPACE_MODE:-isolated}
    volumes:
      - ./workspace:/workspace
    stdin_open: true
    tty: true

volumes:
  redis-data:
```

#### .dockerignore

```
node_modules
dist
.git
.github
tests
*.md
.env
.DS_Store
npm-debug.log
```

---

### 3. Testing Framework Improvements

#### Add Vitest

**Update package.json:**

```json
{
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vitest/ui": "^1.0.0"
  },
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage"
  }
}
```

#### Test Structure

```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ memory-store.test.ts      # MemoryStore unit tests
â”‚   â”œâ”€â”€ embeddings.test.ts        # Embedding generation tests
â”‚   â””â”€â”€ types.test.ts              # Schema validation tests
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ v1.3.0-global.test.ts     # Global memories tests
â”‚   â”œâ”€â”€ v1.4.0-relationships.test.ts  # Relationship tests
â”‚   â”œâ”€â”€ v1.5.0-versioning.test.ts     # Versioning tests
â”‚   â”œâ”€â”€ v1.5.0-templates.test.ts      # Template tests
â”‚   â””â”€â”€ v1.5.0-categories.test.ts     # Category tests
â”œâ”€â”€ e2e/
â”‚   â””â”€â”€ mcp-protocol.test.ts       # Full MCP protocol tests
â””â”€â”€ helpers/
    â”œâ”€â”€ setup.ts                   # Test setup/teardown
    â””â”€â”€ fixtures.ts                # Test data fixtures
```

#### Example Unit Test

**File:** `tests/unit/memory-store.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { MemoryStore } from '../../src/redis/memory-store.js';
import Redis from 'ioredis';

describe('MemoryStore', () => {
  let redis: Redis;
  let store: MemoryStore;

  beforeEach(async () => {
    redis = new Redis({
      host: 'localhost',
      port: 6379,
      db: 15, // Use separate test DB
    });
    await redis.flushdb();
    store = new MemoryStore(redis, 'test-workspace');
  });

  afterEach(async () => {
    await redis.flushdb();
    await redis.quit();
  });

  describe('storeMemory', () => {
    it('should store a memory with all fields', async () => {
      const memory = await store.storeMemory({
        content: 'Test content',
        context_type: 'information',
        importance: 8,
        tags: ['test'],
      });

      expect(memory).toMatchObject({
        content: 'Test content',
        context_type: 'information',
        importance: 8,
        tags: ['test'],
      });
      expect(memory.id).toBeDefined();
      expect(memory.created_at).toBeDefined();
    });

    it('should generate embeddings', async () => {
      const memory = await store.storeMemory({
        content: 'Test content',
        context_type: 'information',
      });

      expect(memory.embedding).toBeDefined();
      expect(memory.embedding.length).toBeGreaterThan(0);
    });
  });

  describe('searchMemories', () => {
    beforeEach(async () => {
      await store.storeMemory({
        content: 'JavaScript testing with Vitest',
        context_type: 'information',
        importance: 8,
      });
      await store.storeMemory({
        content: 'Python testing with pytest',
        context_type: 'information',
        importance: 7,
      });
    });

    it('should find relevant memories', async () => {
      const results = await store.searchMemories('JavaScript testing', 5);

      expect(results).toHaveLength(2);
      expect(results[0].content).toContain('JavaScript');
      expect(results[0].similarity).toBeGreaterThan(results[1].similarity);
    });

    it('should filter by importance', async () => {
      const results = await store.searchMemories('testing', 5, 8);

      expect(results).toHaveLength(1);
      expect(results[0].content).toContain('JavaScript');
    });
  });
});
```

---

### 4. Fix ANTHROPIC_API_KEY Bug

**Problem:** Server requires ANTHROPIC_API_KEY even when not using `analyze_and_remember` tool.

**Root Cause:** ConversationAnalyzer instantiated at module load time.

**File:** `src/tools/context-tools.ts`

**Current (broken):**
```typescript
import { ConversationAnalyzer } from '../analysis/conversation-analyzer.js';

const analyzer = new ConversationAnalyzer(); // âŒ Instantiated at load time
```

**Fixed (lazy loading):**
```typescript
import { ConversationAnalyzer } from '../analysis/conversation-analyzer.js';

let analyzer: ConversationAnalyzer | null = null;

function getAnalyzer(): ConversationAnalyzer {
  if (!analyzer) {
    analyzer = new ConversationAnalyzer();
  }
  return analyzer;
}

// In tool handler:
analyze_and_remember: {
  handler: async (args) => {
    const analyzer = getAnalyzer(); // âœ… Only instantiated when needed
    // ...
  }
}
```

---

### 5. Improved Error Messages & Logging

#### Add Debug Mode

**File:** `src/utils/logger.ts` (NEW)

```typescript
export enum LogLevel {
  ERROR = 0,
  WARN = 1,
  INFO = 2,
  DEBUG = 3,
}

class Logger {
  private level: LogLevel;

  constructor() {
    const envLevel = process.env.LOG_LEVEL?.toUpperCase();
    this.level = LogLevel[envLevel as keyof typeof LogLevel] ?? LogLevel.INFO;
  }

  error(message: string, meta?: Record<string, unknown>): void {
    if (this.level >= LogLevel.ERROR) {
      console.error(JSON.stringify({ level: 'ERROR', message, ...meta, timestamp: new Date().toISOString() }));
    }
  }

  warn(message: string, meta?: Record<string, unknown>): void {
    if (this.level >= LogLevel.WARN) {
      console.warn(JSON.stringify({ level: 'WARN', message, ...meta, timestamp: new Date().toISOString() }));
    }
  }

  info(message: string, meta?: Record<string, unknown>): void {
    if (this.level >= LogLevel.INFO) {
      console.log(JSON.stringify({ level: 'INFO', message, ...meta, timestamp: new Date().toISOString() }));
    }
  }

  debug(message: string, meta?: Record<string, unknown>): void {
    if (this.level >= LogLevel.DEBUG) {
      console.log(JSON.stringify({ level: 'DEBUG', message, ...meta, timestamp: new Date().toISOString() }));
    }
  }
}

export const logger = new Logger();
```

#### Better Error Messages

**Example in memory-store.ts:**

```typescript
// Before
throw new Error('Memory not found');

// After
throw new Error(
  `Memory not found: ${memoryId}. ` +
  `Workspace: ${this.workspaceId}. ` +
  `Check that the memory exists with: memory://recent`
);
```

#### Connection Diagnostics

**Add to src/index.ts:**

```typescript
async function diagnostics(): Promise<void> {
  logger.info('Running diagnostics...');

  // Redis connection
  try {
    await redis.ping();
    logger.info('âœ“ Redis connection successful', { url: redisUrl });
  } catch (error) {
    logger.error('âœ— Redis connection failed', { url: redisUrl, error: (error as Error).message });
  }

  // OpenAI API key
  if (process.env.OPENAI_API_KEY) {
    logger.info('âœ“ OPENAI_API_KEY is set');
  } else {
    logger.warn('âš  OPENAI_API_KEY not set - embeddings will fail');
  }

  // Workspace
  logger.info('Workspace information', {
    id: workspaceId,
    mode: process.env.WORKSPACE_MODE || 'isolated',
  });

  // Memory count
  const count = await redis.scard(RedisKeys.memories(workspaceId));
  logger.info('Memory statistics', { total_memories: count });
}

// Run on startup if DEBUG mode
if (process.env.LOG_LEVEL === 'DEBUG') {
  await diagnostics();
}
```

---

### 6. Additional Improvements

#### Add ESLint & Prettier

**package.json:**
```json
{
  "devDependencies": {
    "eslint": "^8.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "prettier": "^3.0.0"
  },
  "scripts": {
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix",
    "format": "prettier --write \"src/**/*.ts\""
  }
}
```

**.eslintrc.json:**
```json
{
  "parser": "@typescript-eslint/parser",
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "warn",
    "@typescript-eslint/explicit-function-return-type": "off"
  }
}
```

#### GitHub Templates

**File:** `.github/PULL_REQUEST_TEMPLATE.md`

```markdown
## Description
<!-- Describe your changes -->

## Type of Change
- [ ] Bug fix
- [ ] New feature
- [ ] Breaking change
- [ ] Documentation update

## Testing
- [ ] TypeScript compiles without errors
- [ ] Static tests pass (`./tests/test-v1.5.0-simple.sh`)
- [ ] Runtime tests pass (`node tests/test-runtime.js`)
- [ ] Manual testing completed
- [ ] Added/updated tests for changes

## Documentation
- [ ] Updated README.md if needed
- [ ] Updated CHANGELOG.md
- [ ] Added/updated code comments

## Checklist
- [ ] Code follows project style guidelines
- [ ] No breaking changes (or documented in CHANGELOG)
- [ ] All tests passing
- [ ] Version bumped (if releasing)
```

---

## Implementation Plan

### Phase 1: Bug Fixes (1 hour)

- [ ] Fix ANTHROPIC_API_KEY requirement (lazy loading)
- [ ] Test fix works without API key
- [ ] Update error messages to be more helpful

### Phase 2: Testing Framework (2 hours)

- [ ] Add Vitest dependency
- [ ] Create test structure (unit/integration/e2e)
- [ ] Write unit tests for MemoryStore
- [ ] Write integration tests for v1.3-v1.5 features
- [ ] Add test helpers and fixtures
- [ ] Update npm scripts

### Phase 3: CI/CD Pipeline (2 hours)

- [ ] Create `.github/workflows/test.yml`
- [ ] Create `.github/workflows/security.yml`
- [ ] Create `.github/workflows/publish.yml`
- [ ] Add GitHub secrets (NPM_TOKEN, SNYK_TOKEN)
- [ ] Test workflows on feature branch

### Phase 4: Docker Support (1.5 hours)

- [ ] Create Dockerfile (multi-stage build)
- [ ] Create docker-compose.yml
- [ ] Create .dockerignore
- [ ] Test Docker build locally
- [ ] Test Docker Compose setup
- [ ] Add Docker documentation

### Phase 5: Code Quality (1 hour)

- [ ] Add ESLint configuration
- [ ] Add Prettier configuration
- [ ] Run linter and fix issues
- [ ] Add logging utility
- [ ] Add diagnostics function
- [ ] Improve error messages across codebase

### Phase 6: GitHub Templates (30 min)

- [ ] Create PR template
- [ ] Create bug report template
- [ ] Create feature request template
- [ ] Update CONTRIBUTING.md

### Phase 7: Documentation (1 hour)

- [ ] Update README with Docker instructions
- [ ] Update README with CI/CD badges
- [ ] Document logging configuration
- [ ] Update CHANGELOG for v1.6.0
- [ ] Create TESTING.md guide
- [ ] Update version to 1.6.0

---

## Success Criteria

- [ ] All tests pass in CI/CD pipeline
- [ ] Docker image builds successfully
- [ ] Can run server without ANTHROPIC_API_KEY
- [ ] Vitest test suite covers core functionality
- [ ] GitHub Actions workflows working
- [ ] Security scanning configured
- [ ] npm publish automated on release
- [ ] Error messages are helpful
- [ ] Logging system in place
- [ ] PR template enforces quality checks
- [ ] Documentation updated
- [ ] No breaking changes

---

## Migration Guide

### For Users

**No breaking changes!** v1.6.0 is fully backward compatible.

**New capabilities:**
- Docker deployment option
- Better error messages
- Optional debug logging
- ANTHROPIC_API_KEY no longer required (only for analyze_and_remember)

**Upgrading:**
```bash
npm update @joseairosa/recall
```

**Using Docker:**
```bash
# Clone repo
git clone <repo-url>
cd recall

# Start with Docker Compose
docker-compose up -d

# Or build and run manually
docker build -t recall .
docker run -e REDIS_URL=redis://host -e OPENAI_API_KEY=sk-... recall
```

### For Contributors

**New workflow:**
1. All PRs must pass CI/CD checks
2. Run `npm test` before committing
3. Follow PR template checklist
4. Code must pass linting

**Testing:**
```bash
# Run all tests
npm test

# Run with UI
npm run test:ui

# Run with coverage
npm run test:coverage
```

---

## Notes

- Keep CI/CD workflows simple initially, can expand later
- Docker image should be lightweight (Alpine-based)
- Vitest chosen over Jest for speed and ESM support
- Logging is JSON for easier parsing/filtering
- GitHub Actions free tier: 2000 min/month (plenty for this project)
- Consider publishing Docker image to Docker Hub in future

---

## Example Usage

### Running Tests Locally

```bash
# Unit tests
npm test tests/unit

# Integration tests (requires Redis)
npm test tests/integration

# E2E tests
npm test tests/e2e

# Watch mode during development
npm run test:watch
```

### Using Docker

```bash
# Development with Docker Compose
docker-compose up

# Production deployment
docker run -d \
  -e REDIS_URL=rediss://prod-redis:6379 \
  -e OPENAI_API_KEY=sk-... \
  -v /app/workspace:/workspace \
  recall:latest
```

### Debug Logging

```bash
# Enable debug logs
LOG_LEVEL=DEBUG node dist/index.js

# Run diagnostics
LOG_LEVEL=DEBUG node dist/index.js 2>&1 | grep diagnostics
```

---

**Last Updated:** 2025-10-04
**Author:** JosÃ© Airosa
